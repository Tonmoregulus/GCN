### threshold = 0	KNN_neighbors = 50	n_rescon = 0.1

![image-20240412142757575](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412142757575.png)

![image-20240412142956185](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412142956185.png)

![image-20240412143019009](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412143019009.png)

### threshold = 0	KNN_neighbors = 20	n_rescon = 0.1

![image-20240412143103797](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412143103797.png)

![image-20240412143330573](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412143330573.png)

![image-20240412143347382](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412143347382.png)

### threshold = 0.8	KNN_neighbors = 50	n_rescon = 0.1

![image-20240412144619827](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412144619827.png)

### threshold = 0.8	KNN_neighbors = 20	n_rescon = 0.1

![image-20240412144810503](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412144810503.png)

![image-20240412145133719](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412145133719.png)

### threshold = 0.95	KNN_neighbors = 20	n_rescon = 0.1

![image-20240412145307298](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412145307298.png)

![image-20240412145552292](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240412145552292.png)

## threshold = 0.8	KNN_neighbors = 5	n_rescon = 0.1

![image-20240414000439977](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414000439977.png)

![image-20240414000700312](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414000700312.png)

### threshold = 0.8	KNN_neighbors = 5	n_rescon = 0

![image-20240414000810217](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414000810217.png)

![image-20240414001309411](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414001309411.png)

### threshold = 0.8	KNN_neighbors = 5	n_rescon = 0.2

![image-20240414001400844](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414001400844.png)

![image-20240414001616615](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414001616615.png)

### threshold = 0.8	KNN_neighbors = 10	n_rescon = 0.1

![image-20240414001742311](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414001742311.png)

![image-20240414001937692](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414001937692.png)

### threshold = 0.8	KNN_neighbors = 3	n_rescon = 0.1

![image-20240414002103961](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414002103961.png)

![image-20240414002313324](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414002313324.png)

### threshold = 0.8	KNN_neighbors = 5	n_rescon = 0.1	lr = 0.05

![image-20240414003132544](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414003132544.png)

![image-20240414003415264](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414003415264.png)

### threshold = 0.95	KNN_neighbors = 5	n_rescon = 0.1

![image-20240414003532740](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414003532740.png)

![image-20240414003740349](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414003740349.png)

### threshold = 0.8	KNN_neighbors = 5	n_rescon = 0.1	stage = 10

![image-20240414003921284](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414003921284.png)

![image-20240414004319944](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414004319944.png)

### threshold = 0.8	KNN_neighbors = 5	n_rescon = 0.1	stage = 20

![image-20240414004703709](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414004703709.png)

![image-20240414004729955](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414004729955.png)

![image-20240414004756681](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414004756681.png)

![image-20240414004820580](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414004820580.png)

![image-20240414004847393](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414004847393.png)

![image-20240414004916722](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414004916722.png)

![image-20240414005000944](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005000944.png)

![image-20240414005034646](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005034646.png)

![image-20240414005122707](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005122707.png)

![image-20240414005148142](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005148142.png)

![image-20240414005212605](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005212605.png)

![image-20240414005247308](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005247308.png)

![image-20240414005320158](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005320158.png)

![image-20240414005345863](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005345863.png)

![image-20240414005409898](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005409898.png)

![image-20240414005435595](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005435595.png)

![image-20240414005508600](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005508600.png)

![image-20240414005532475](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005532475.png)

![image-20240414005609432](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005609432.png)

![image-20240414005633212](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414005633212.png)

![image-20240414010045256](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414010045256.png)

# NEW



### threshold = 0.95	KNN_neighbors = 5	n_rescon_1 = 0.1	n_rescon_2 = 0.1	stage = 10

![image-20240414121709060](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414121709060.png)

![image-20240414121726181](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414121726181.png)

![image-20240414122318847](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414122318847.png)

![image-20240414122401843](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414122401843.png)

![image-20240414123148060](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414123148060.png)

# NEW NEW

### threshold = 0.8	KNN_neighbors = 30	n_neighbors=1	n_rescon_1 = 0.1	n_rescon_2 = 0.1	stage = 5

![image-20240414203316897](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414203316897.png)

![image-20240414203401473](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414203401473.png)

![image-20240414203446333](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414203446333.png)

![image-20240414203531694](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414203531694.png)

![image-20240414203615386](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414203615386.png)

![image-20240414203834243](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240414203834243.png)



### threshold = 0.8	KNN_neighbors = 30	n_neighbors=1	n_rescon_1 = 0.1	n_rescon_2 = 0.1	*stage = 3*

 train acc : 92.31 | valid acc : 69.33 | test acc : 69.64

### threshold = 0.8	KNN_neighbors = 30	n_neighbors=1	n_rescon_1 = 0.1	n_rescon_2 = 0.1	*stage = 1*

train acc : 86.54 | valid acc : 68.59 | test acc : 70.18

### threshold = 0.8	KNN_neighbors = 30	n_neighbors=1	*n_rescon_1 = 1*	n_rescon_2 = 0.1	stage = 1

train acc : 80.77 | valid acc : 69.89 | test acc : 70.51

### threshold = 0.8	KNN_neighbors = 30	n_neighbors=1	*n_rescon_1 = 10*	n_rescon_2 = 0.1	stage = 1

train acc : 88.46 | valid acc : 62.08 | test acc : 65.50

### threshold = 0.8	KNN_neighbors = 30	n_neighbors=1	n_rescon_1 = 1	n_rescon_2 = 0.1	*stage = 2*

train acc : 100.00 | valid acc : 70.07 | test acc : 70.20

### *threshold = 0.95*	KNN_neighbors = 30	n_neighbors=1	n_rescon_1 = 1	n_rescon_2 = 0.1	stage = 1

train acc : 82.69 | valid acc : 69.89 | test acc : 70.07

### threshold = 0.8	*KNN_neighbors = 20*	n_neighbors=1	n_rescon_1 = 1	n_rescon_2 = 0.1	stage = 1

train acc : 82.69 | valid acc : 69.70 | test acc : 70.71

### threshold = 0.8	*KNN_neighbors = 40*	n_neighbors=1	n_rescon_1 = 1	n_rescon_2 = 0.1	stage = 1

train acc : 82.69 | valid acc : 69.70 | test acc : 70.80

### threshold = 0.8	*KNN_neighbors = 50*	n_neighbors=1	n_rescon_1 = 1	n_rescon_2 = 0.1	stage = 1

train acc : 84.62 | valid acc : 69.70 | test acc : 70.71





![image-20240422105308194](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240422105308194.png)

![image-20240422105414227](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20240422105414227.png)





好的，接下来我希望在     

        for i, indices in enumerate(knn_indices):
            # 确保indices是一维的
            indices = indices.flatten()
        
            # 更新训练掩码，将找到的未标记数据标记为已标记
            # 转换索引回原始数据集的索引并确保不越界
            true_indices = unlabeled_indices_cpu[indices]
            valid_indices_mask = true_indices < len(unlabeled_indices)
            valid_indices = true_indices[valid_indices_mask]
            self.train_mask[unlabeled_indices[valid_indices]] = True

  这里找到的打算扩充的indices加一点要求：进行KNN邻近搜索，搜索内容是rep[unlabeled_indices.cpu()]，数量是30个，然后通过计算这些unlabeled data的logits得到它们对于该类的平均logits，如果平均logits大于0.5才把这个indice变为labeled_indice，如果小于0.5则把不变















































<!-- 
采用KMeans时多出的代码
```
        
        # # Perform K-Means clustering on all data using initial centroids
        # clustering = KMeans(n_clusters=self.num_classes, init=initial_centroids, n_init=1).fit(rep)
        # clustering_result = clustering.predict(rep)
        
        # # Update centroids based on new clustering
        # new_centroids = clustering.cluster_centers_
        
        # new_centroids = initial_centroids


# # 画TSNE图
        # combined_rep = np.vstack((rep, new_centroids))
        
        # tsne = TSNE(n_components=2, random_state=42, perplexity=30)
        # combined_rep_2d = tsne.fit_transform(combined_rep)
        
        # rep_2d = combined_rep_2d[:-len(new_centroids)]
        # centroids_2d = combined_rep_2d[-len(new_centroids):]
        
        # _, nearest_indices = knn.kneighbors(new_centroids, n_neighbors=n_neighbors)
        # nearest_indices_global = unlabeled_indices[nearest_indices.flatten()]
        
        # nearest_indices_global_cpu = nearest_indices_global.cpu()
        # nearest_samples_2d = rep_2d[nearest_indices_global_cpu]

        # labeled_indices_cpu = labeled_indices.cpu().numpy()
        # labeled_data_2d = rep_2d[labeled_indices_cpu]
        
        # plt.figure(figsize=(12, 8))
        # plt.scatter(rep_2d[:, 0], rep_2d[:, 1], alpha=0.2, label='All Data', color='grey')
        # plt.scatter(centroids_2d[:, 0], centroids_2d[:, 1], color='red', marker='x', s=100, label='Centroids')      
        # plt.scatter(labeled_data_2d[:, 0], labeled_data_2d[:, 1], color='blue', label='Labeled Data')
        # plt.scatter(nearest_samples_2d[:, 0], nearest_samples_2d[:, 1], color='green', label='KNN Nearest Unlabeled Data')

        # plt.legend()
        # plt.title('t-SNE Visualization of Data, Centroids, and Nearest Unlabeled Samples')
        # plt.xlabel('t-SNE Dimension 1')
        # plt.ylabel('t-SNE Dimension 2')
        # plt.show()       
        
        
        
        
        # # KMeans后对聚类中心构建正负样本对
        # positive_samples = []
        # negative_samples = []
        
        # for i, centroid in enumerate(new_centroids):
        #     # 找到最接近质心的未标记节点
        #     _, pos_indices = knn.kneighbors([centroid], n_neighbors=n_neighbors)
        #     pos_indices = pos_indices.flatten()
        #     pos_indices = unlabeled_indices[pos_indices]
            
        #     # 收集正样本的嵌入向量
        #     pos_indices_cpu = pos_indices.cpu().numpy()
        #     pos_embeddings = torch.tensor(rep[pos_indices_cpu], device=self.device)
        
        #     # 从其他类别中收集负样本的嵌入向量
        #     neg_embeddings_list = []
        #     for j in range(self.num_classes):
        #         if j != i:
        #             _, neg_indices = knn.kneighbors([new_centroids[j]], n_neighbors=n_neighbors)
        #             neg_indices = neg_indices.flatten()
        #             neg_indices = unlabeled_indices[neg_indices]
        #             neg_indices_cpu = neg_indices.cpu().numpy()
        #             neg_embeddings_list.append(torch.tensor(rep[neg_indices_cpu], device=self.device))
        
        #     # 合并来自所有其他类的负样本嵌入向量
        #     neg_embeddings = torch.cat(neg_embeddings_list, dim=0)
            
        #     # 存储正样本和负样本
        #     positive_samples.append((pos_embeddings, centroid))
        #     negative_samples.append((neg_embeddings, centroid))
```
-->





| 对比学习前  |       |       |       |       |       |       |       | 对比学习后  |       |       |       |       |       |       |       |
| ----------- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----------- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| stage\class | 0     | 1     | 2     | 3     | 4     | 5     | 6     | stage\class | 0     | 1     | 2     | 3     | 4     | 5     | 6     |
| fold1       |       |       |       |       |       |       |       | fold1       |       |       |       |       |       |       |       |
| 1           | 0.171 | 0.133 | 0.185 | 0.237 | 0     | 0     | 0.412 | 1           | 0.181 | 0.138 | 0.189 | 0.251 | 0     | 0     | 0.388 |
| 2           | 0.132 | 0.172 | 0.222 | 0.262 | 0.450 | 0.484 | 0.254 | 2           | 0.136 | 0.193 | 0.225 | 0.281 | 0.462 | 0.448 | 0.268 |
| 3           | 0.119 | 0.163 | 1.076 | 0.771 | 0.314 | 0.199 | 0.259 | 3           | 0.113 | 0.168 | 1.076 | 0.764 | 0.311 | 0.206 | 0.278 |
| 4           | 0.150 | 0.167 | 0.255 | 0.328 | 0.965 | 0.320 | 0.339 | 4           | 0.144 | 0.178 | 0.251 | 0.330 | 0.983 | 0.285 | 0.317 |
| 5           | 0.136 | 0.145 | 0.643 | 0.244 | 1.015 | 0.982 | 1.097 | 5           | 0.136 | 0.143 | 0.631 | 0.306 | 0.998 | 0.989 | 1.118 |
| fold2       |       |       |       |       |       |       |       | fold2       |       |       |       |       |       |       |       |
| 1           | 1.314 | 0     | 0     | 0.345 | 0.193 | 0.195 | 0     | 1           | 1.378 | 0     | 0     | 0.342 | 0.182 | 0.192 | 0     |
| 2           | 0.453 | 0     | 0.164 | 0.295 | 1.094 | 0.348 | 0.358 | 2           | 0.428 | 0     | 0.167 | 0.282 | 1.091 | 0.369 | 0.310 |
| 3           | 1.243 | 0     | 0.193 | 0.758 | 1.354 | 0.122 | 0.223 | 3           | 1.229 | 0     | 0.184 | 0.755 | 1.39  | 1.114 | 0.202 |
| 4           | 1.321 | 0     | 0.171 | 0.654 | 0.879 | 0.747 | 0.184 | 4           | 1.325 | 0     | 0.161 | 0.643 | 0.873 | 0.744 | 0.161 |
| 5           | 1.285 | 0     | 0.170 | 0.558 | 0.763 | 0.679 | 1.096 | 5           | 1.284 | 0     | 0.171 | 0.554 | 0.753 | 0.683 | 1.088 |

